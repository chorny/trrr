#!/usr/bin/env perl

use 5.010;
use strict;
use warnings;

use POSIX qw< ceil >;
use Encode qw< encode >;
use HTTP::Tiny;
use JSON::PP;
use Term::ANSIColor;
use App::Trrr::HotKey qw< readkey >;
use App::Trrr::Open qw< open_app >;
#binmode(STDOUT, ":utf8");

unless(@ARGV){ system("perldoc trrr"); exit }
if( $ARGV[0] eq '-h' ){ system("perldoc trrr"); exit }
my @keyword = ();


# custon getopt; if param starts with '-' check if its letter or number
# if number set seedlimit if letter skip readkey() which is mandatory on windows as there is no POSIX::termios_h
my $opt = {
    os      =>  "$^O",
    seeds   =>  0,
};

for(@ARGV){
    if(/^\-/){
        s/\-//;
        if(/[a-z]/){ $opt->{key} = lc $_ } else { $opt->{seeds} = int $_ } 
    } else { push @keyword, $_ }
}

#say 'seeds:' . $opt->{seeds};
#say 'key:' . $opt->{key};

#die;
my $torrent_file = "$ENV{HOME}/Downloads/trrr.torrent";
my $url = 'http://extratorrent.cc/json/?cid=4&search=' . join '+', @keyword;

my $response = HTTP::Tiny->new->get($url);
my $results = decode_json( encode('utf8', $response->{content}) );

my $strip = sub {
    my( $item, $field ) = @_;
    my $term_width  = int `tput cols`; 
    my $size = ceil(int($item->{size})/1000/1000);
    
    my $line = $item->{key} . ' ' . $item->{seeds} . ' ' . "$item->{title}" . ' ' . $item->{category} . ' ' . $size . 'M';
    my $max = $term_width - length($line);

    if( $term_width < length($line)){
        my $strip = length($line) - $term_width;
        my $stripped_title = $term_width - $strip + 0;
        $item->{title} = substr( $item->{title},0,$max);
    } 
    my $title = $item->{title};
    my $striped = {};
    $striped->{title} = $title;
    $striped->{size} = $size;
    return $striped->{$field}
};


sub show {
    my $key = 'A';
    my $key_color;
    my $i = 1;
    my @filter = grep { int($_->{seeds}) > int($opt->{seeds}) } @{$results->{list}};
    @filter = sort { $b->{seeds} <=> $a->{seeds} } @filter;
    my @f = splice(@filter,0,15);

    for(@f){
        if( $i % 2 ){ $key_color = 'black on_white' } else { $key_color = 'white on_black' }

        $_->{key} = $key;
        #push @filter, $_->{key};
        #if($_->{category} eq 'Movies'){ $_->{category} = "\x{1f3a5}" . ' ' }
        my $title = $strip->($_,'title');
        my $size = $strip->($_,'size');
        my $category = $strip->($_, 'category');
        say colored([$key_color],$key) . ' ' . colored(['cyan'],$_->{seeds}) . ' ' .  colored(['yellow'],$title) . ' ' . colored(['white'],$_->{category}) . ' ' . $size . 'M' unless defined $opt->{key};
        $key++; $i++;
    }
    key(\@f);
}

sub key {
    my $filter = shift;
        get_torrent($filter) if defined $opt->{key};

        if($opt->{os} eq 'MSWin32' or $opt->{os} eq 'msys'){ 
            exit unless defined $opt->{key};
        } else {
            require App::Trrr::HotKey;
            App::Trrr::HotKey->import( 'readkey' ) ;
            $opt->{key} = readkey();
            get_torrent($filter);
        }
}

sub get_torrent {
    my $filter = shift;
    say 'saving ~/Downloads/trrr.torrent' if $opt->{key} =~ /[a-o]/;
    my @picked = grep { $_->{key} eq uc $opt->{key} } @$filter;

    for(@picked){ 
        my $torrent = HTTP::Tiny->new->get("$_->{torrentLink}");
        open(my $fh,'>',$torrent_file)||die "cant open $torrent_file: $!";
        print $fh $torrent->{content};
        close $fh;
        open_app($torrent_file);
        exit;
    }
}

show();

=head1 NAME

trrr - search torrents from CLI


=head1 SYNOPSIS

CLI tool for searching torrents using as few keystrokes as it gets. It's using extratorrent API, filters and sorts results which are then mapped to keys. Press the key with assigned letter and it will download+open torrent in your default torrent client. 

=head1 USAGE

- filter results with as many parameters as needed

- search for pulp fiction

C<trrr perl tutorial video>

- to limit results by minimum number of seeders add -Nr as last parameter

C<trrr perl tutorial video -100>

- first column is assigned key. To pick a result pres assigned key and it'll be opened in your default torrent client.

=cut

__DATA__
get movie box json

get db link
curl -L 'http://sbfunapi.cc/api/serials/get_db_link/' > db_link

get zip of db
curl --user-agent "MovieBox3/3.6.8 (iPhone; iOS 8.4; Scale/2.00)" -L "https://vk.com/doc199140917_439773875" > db2

unzip db2



#!/usr/bin/env perl

my $module = 'notok';
my $os = "$^O";
#print $os;

unless($os eq 'MSWin32' or $os eq 'msys'){
    require App::Trrr::HotKey;
    App::Trrr::HotKey->import( readkey ) ;
    my $key = readkey();
    print 'os is unix' . $key . "\n";
} else {
    print "no readkey";
}


__DATA__
# win support 
# use pl2bat;


my $rc = eval
{
  require App::Trrr::HotKey;
  App::Trrr::HotKey->import();
  1;
};

if($rc)
{
    $module = 'ok';
  # Term::ReadKey loaded and imported successfully
}

print $module;
